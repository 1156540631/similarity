ExecuteServiceCommand(int argc, LPWSTR *argv)
if (!lstrcmpi(argv[2], L"software-update")) {
result = ProcessSoftwareUpdateCommand(argc - 3, argv + 3);
ProcessSoftwareUpdateCommand(DWORD argc, LPWSTR *argv)
if (!GetInstallationDir(argc, argv, installDir)) {
GetInstallationDir(int argcTmp, LPWSTR *argvTmp, WCHAR aResultDir[MAX_PATH])
wcscpy(aResultDir, argvTmp[2]);
bool backgroundUpdate = IsUpdateBeingStaged(argcTmp, argvTmp);
if (!IsLocalFile(argv[0], isLocal) || !isLocal) {
nsAutoHandle noWriteLock(CreateFileW(argv[0], GENERIC_READ, FILE_SHARE_READ,
if (result && !VerifySameFiles(argv[0], installDirUpdater,
HMODULE updaterModule = LoadLibraryEx(argv[0], NULL,
argv[0]);
if (StartUpdateProcess(argc, argv, installDir,
LPWSTR *argv,
LPWSTR cmdLine = MakeCommandLine(argc, argv);
PRUnichar* MakeCommandLine(int argc, PRUnichar **argv);
WCHAR updateStatusFilePath[MAX_PATH + 1];
wcscpy(updateStatusFilePath, updateDirPath);
PathGetSiblingFilePath(updaterINITemp, argv[0], L"updater.tmp")) {
BOOL PathGetSiblingFilePath(LPWSTR destinationBuffer,  LPCWSTR siblingFilePath,
if (PathGetSiblingFilePath(updaterINI, argv[0], L"updater.ini") &&
processStarted = CreateProcessW(argv[0], cmdLine,
if (IsStatusApplying(argv[1], isApplying) && isApplying) {
BOOL PathGetSiblingFilePath(LPWSTR destinationBuffer,  LPCWSTR siblingFilePath,
processStarted = CreateProcessW(argv[0], cmdLine,
if (IsStatusApplying(argv[1], isApplying) && isApplying) {
IsStatusApplying(LPCWSTR updateDirPath, BOOL &isApplying)
wcscpy(updateStatusFilePath, updateDirPath);
IsUpdateBeingStaged(int argc, LPWSTR *argv)
return argc == 4 && !wcscmp(argv[3], L"-1");
bool replaceRequest = (argcTmp >= 4 && wcsstr(argvTmp[3], L"/replace"));
if (!IsLocalFile(argv[0], isLocal) || !isLocal) {
nsAutoHandle noWriteLock(CreateFileW(argv[0], GENERIC_READ, FILE_SHARE_READ,
if (result && !VerifySameFiles(argv[0], installDirUpdater,
HMODULE updaterModule = LoadLibraryEx(argv[0], NULL,
argv[0]);
if (StartUpdateProcess(argc, argv, installDir,
LPWSTR *argv,
LPWSTR cmdLine = MakeCommandLine(argc, argv);
